#
# elastos.org server config
# useful nginx configuration for reverse proxy with Apache
#

# upstream is for nginx load balance
#upstream ElastosOrg {
#ip_hash;
#server 192.168.7.13:80  weight=1;  #the bigger of weight, the more work will give to it, default is 1
#server 192.168.7.14:80  down;      #this server now is down state, not service
#server 192.168.7.18:80  backup;    #this server won't work until all other servers are down
#server 192.168.7.15:8009  max_fails=3  fail_timeout=20s;
#server 192.168.7.16:8080;
#}

# clusterA, elastos.org wordpress etc
upstream clusterA {
ip_hash;
server 192.168.7.178:80;
}

# clusterB, elastos.org Gerrit, Redmine
upstream clusterB {
ip_hash;
server 192.168.7.128:80;
}

# clusterC, jenkins etc
upstream clusterC {
ip_hash;
server 192.168.7.138:8080;
}

# clusterD, DocBanyan etc
upstream clusterD {
ip_hash;
server 192.168.7.64:80;
}

# clusterE, extmail etc
upstream clusterE {
ip_hash;
server 192.168.3.15:80;
}

server {
 
    listen 80;

    server_name elastos.org *.elastos.org;
    
    root /opt/rubystack/nginx/html;
    error_page  404  = /404.html;
    error_page  500 502 503 504  = /50x.html;

    #location /fallback {
    #    root /opt/rubystack/nginx/html;
    #    index index.html index.htm;
    #    try_files $uri $uri/index.html;
    #}

    location / {
        #limit_conn one 1;
        #limit_rate 100k;
  
        proxy_intercept_errors on;
  
        proxy_pass http://clusterA;
        proxy_redirect off;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
 
        client_max_body_size 16m;
        client_body_buffer_size 128k;
 
        proxy_connect_timeout 90;
        proxy_send_timeout 90;
        proxy_read_timeout 90;
        proxy_buffer_size 4k;
        proxy_buffers 4 32k;
        proxy_busy_buffers_size 64k;
        proxy_temp_file_write_size 64k;
    }

    location ^~/review {
        #limit_conn one 1;
        #limit_rate 100k;
  
        proxy_intercept_errors on;

        proxy_pass http://clusterB/review;
        proxy_redirect off;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
 
        client_max_body_size 16m;
        client_body_buffer_size 128k;
 
        proxy_connect_timeout 90;
        proxy_send_timeout 90;
        proxy_read_timeout 90;
        proxy_buffer_size 4k;
        proxy_buffers 4 32k;
        proxy_busy_buffers_size 64k;
        proxy_temp_file_write_size 64k;
    }

    location ^~/project {
        #limit_conn one 1;
        #limit_rate 100k;
  
        proxy_intercept_errors on;

        proxy_pass http://clusterB/project;
        proxy_redirect off;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
 
        client_max_body_size 16m;
        client_body_buffer_size 128k;
 
        proxy_connect_timeout 90;
        proxy_send_timeout 90;
        proxy_read_timeout 90;
        proxy_buffer_size 4k;
        proxy_buffers 4 32k;
        proxy_busy_buffers_size 64k;
        proxy_temp_file_write_size 64k;
    }

    location ^~/ProjectsFiles {
        #limit_conn one 1;
        #limit_rate 100k;
  
        proxy_intercept_errors on;

        proxy_pass http://clusterB/ProjectsFiles;
        proxy_redirect off;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
 
        client_max_body_size 16m;
        client_body_buffer_size 128k;
 
        proxy_connect_timeout 90;
        proxy_send_timeout 90;
        proxy_read_timeout 90;
        proxy_buffer_size 4k;
        proxy_buffers 4 32k;
        proxy_busy_buffers_size 64k;
        proxy_temp_file_write_size 64k;
    }

    location ^~/redmine {
        #limit_conn one 1;
        #limit_rate 100k;
  
        proxy_intercept_errors on;

        proxy_pass http://clusterB/redmine;
        proxy_redirect off;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
 
        client_max_body_size 16m;
        client_body_buffer_size 128k;
 
        proxy_connect_timeout 90;
        proxy_send_timeout 90;
        proxy_read_timeout 90;
        proxy_buffer_size 4k;
        proxy_buffers 4 32k;
        proxy_busy_buffers_size 64k;
        proxy_temp_file_write_size 64k;
    }

    location ^~/jenkins {
        #limit_conn one 1;
        #limit_rate 100k;
  
        proxy_intercept_errors on;

        proxy_pass http://clusterC/jenkins;
        proxy_redirect off;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
 
        client_max_body_size 16m;
        client_body_buffer_size 128k;
 
        proxy_connect_timeout 90;
        proxy_send_timeout 90;
        proxy_read_timeout 90;
        proxy_buffer_size 4k;
        proxy_buffers 4 32k;
        proxy_busy_buffers_size 64k;
        proxy_temp_file_write_size 64k;
    }

    location ^~/DocBanyan {
        #limit_conn one 1;
        #limit_rate 100k;
  
        proxy_intercept_errors on;

        proxy_pass http://clusterD;
        proxy_redirect off;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
 
        client_max_body_size 16m;
        client_body_buffer_size 128k;
 
        proxy_connect_timeout 90;
        proxy_send_timeout 90;
        proxy_read_timeout 90;
        proxy_buffer_size 4k;
        proxy_buffers 4 32k;
        proxy_busy_buffers_size 64k;
        proxy_temp_file_write_size 64k;
    }

    location ^~/extmail {
        #limit_conn one 1;
        #limit_rate 100k;
  
        proxy_intercept_errors on;

        proxy_pass http://clusterE;
        proxy_redirect off;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
 
        client_max_body_size 16m;
        client_body_buffer_size 128k;
 
        proxy_connect_timeout 90;
        proxy_send_timeout 90;
        proxy_read_timeout 90;
        proxy_buffer_size 4k;
        proxy_buffers 4 32k;
        proxy_busy_buffers_size 64k;
        proxy_temp_file_write_size 64k;
    }
 
    #location ~* ^.+.(jpg|jpeg|gif|png|ico|css|zip|tgz|gz|rar|bz2|doc|xls|exe|pdf|ppt|txt|tar|mid|midi|wav|bmp|rtf|js)$ {
    #    root /path/to/wordpress; #edit path to wordpress install
    #}
 
    if (-f $request_filename) {
        break;
    }
 
    if (-d $request_filename) {
        break;
    }
 
    set $supercache_file .;
 
    set $supercache_uri $request_uri;
 
    if ($request_method = POST) {
        set $supercache_uri .;
    }
 
    if ($query_string) {
        set $supercache_uri .;
    }
 
    if ($http_cookie ~* .comment_author_|wordpress|wp-postpass_. ) {
        set $supercache_uri .;
    }
 
    if ($supercache_uri ~ ^(.+)$) {
        set $supercache_file /wp-content/cache/supercache/$http_host/$1index.html;
    }
    
    if (-f $document_root$supercache_file) {
        rewrite ^(.*)$ $supercache_file break;
    }
}
